(function(d){function e(i,j,h){if(i<j){return j}if(i>h){return h}return i}function b(m,k){var h=e(m.x,k.x-k.width/2,k.x+k.width/2),l=e(m.y,k.y-k.height/2,k.y+k.height/2),j=m.x-h,i=m.y-l;return Math.pow(j,2)+Math.pow(i,2)<Math.pow(m.radius,2)}function a(h,l){var j=h.x-l.x,i=h.y-l.y,k=h.radius+l.radius;return Math.pow(j,2)+Math.pow(i,2)<=Math.pow(k,2)}function g(h,i){return !(i.x-i.width/2>h.x+h.width/2||i.x+i.width/2<h.x-h.width/2||i.y-i.height/2>h.y+h.height/2||i.y+i.height/2<h.y-h.height/2)}function f(){this._collidingWith={};this.type="rectangle"}f.prototype.hitTest=function(h){if(h){if(this.type=="circle"&&h.type=="circle"){return a(this,h)}else{if(this.type=="circle"&&h.type=="rectangle"){return b(this,h)}else{if(this.type=="rectangle"&&h.type=="circle"){return b(h,this)}else{if(this.type=="rectangle"&&h.type=="rectangle"){return g(this,h)}}}}}};f.prototype.collidingWith=function(h,i){if(i==undefined){return this._collidingWith[h.sceneObj.name]==true}else{if(i){this._collidingWith[h.sceneObj.name]=i;h._collidingWith[this.sceneObj.name]=i}else{delete h._collidingWith[this.sceneObj.name];delete this._collidingWith[h.sceneObj.name]}}};function c(){var l=this.position(),k=parseFloat(this.style("width")),h=parseFloat(this.style("height")),j=arguments[0]||{},i=this._shape;if(!this._shape){i=this._shape=new f()}i.type=j.type||i.type;k=j.width||i.width||k;h=j.height||i.height||h;i.x=l.x+k/2;i.y=l.y+h/2;i.width=k;i.height=h;i.sceneObj=this;if(i.type=="circle"){i.radius=Math.max(h,k)/2}if(arguments[0]){return this}return i}scene.loadCollisions=function(m){var j=m.x||0,o=m.y||0,l=m.width,i=m.height,n=m.maxDepth,k=m.maxChildren,h=new QuadTree({x:j,y:o,width:l,height:i},false,n,k);scene.SceneObj.prototype.shape=c;scene.SceneObj.prototype.isCollidable=true;scene.schedule("after",function(p,q){h.clear();h.insert(_.map(q,function(s,r){return s.shape()}));_.each(q,function(x,v){if(x.shape&&x.isCollidable){var s=x.shape(),u=h.retrieve(s),r,w;for(var t=0;t<u.length;t++){r=u[t];if(r==s){continue}w=s.hitTest(r);if(s.collidingWith(r)&&!w){s.collidingWith(r,false)}else{if(!s.collidingWith(r)&&w){s.collidingWith(r,true);scene.events.emit("collision",s.sceneObj.name,r.sceneObj.name)}}}}})})}})(this);
