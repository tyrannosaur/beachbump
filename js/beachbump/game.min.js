(function(F){var x=function(G,H){if(typeof G=="string"){return G==H}else{return G.test(H)}};var d=function(G){var H=Array.prototype.slice.call(arguments,1);for(var I=0;I<H.length;I++){if(x(G,H[I])){return I+1}}return false};var j=function(H){var I=Array.prototype.slice.call(arguments,1),G=[];for(var J=0;J<I.length;J++){if(x(H,I[J])){G.splice(0,0,I[J])}else{G.push(I[J])}}return G};var C=function(K,J){var I=$(K),H=J.cssClass,L=J.start,G=J.end;I.on("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(M){if(M.target==I[0]&&M.originalEvent.animationName==H){I.removeClass(H);if(typeof G=="function"){G.call(null,M)}}}).on("animationstart webkitAnimationStart MSAnimationStart oAnimationStart",function(M){if(M.target==I[0]&&M.originalEvent.animationName==H){if(typeof L=="function"){L.call(null,M)}}});return function(){K.addClass(H)}};var i,m,k,g;var b=256,p=256,s=0,r=0,B,v,t;var h,f,u,l=false,c=false;var n={};var z=[];function e(G){v=G;for(var H=0;H<z.length;H++){z[H].vel(G,z[H].vel().y)}}function A(){if(!l){f+=1;if(f>=h){D.events.emit("lost")}else{D.events.emit("beachball-hit",f,h)}}}n.beachballMap=function(G,H){if(G<=0){G=0}else{if(G>=k-this.width()){G=k-this.width()}}return{x:G,y:H}};n.duneMap=function(G,H){if(t>0&&H<=0){H=g;G=Math.random()*k-this.width()}else{if(t<0&&H>=g){H=0;G=Math.random()*k-this.width()}}return{x:G,y:H}};n.wrapMap=function(G,H){return{x:(G>=0)?G%k:k-(-G%k),y:(H>=0)?H%g:g-(-H%g)}};var D=F.BeachBump={};D.events=new scene.EventEmitter();D.delay=function(){return B};D.invulnerable=function(G){if(G!=undefined){l=Boolean(G);D.events.emit("invulnerable",G)}else{return l}};D.start=function(){D.invulnerable(false);scene.start(B);c=true;D.events.emit("started")};D.unpause=function(){scene.start(B);D.events.emit("unpaused")};D.pause=function(){scene.stop();D.events.emit("paused")};D.restart=function(){f=0;D.invulnerable(true);scene.start(B);c=false;D.events.emit("restarted")};D.started=function(){return c};D.currentHits=function(){return f};D.maxHits=function(){return h};D.load=function(H){var G=scene.parseTime;i=$("#beach");m=$("#beachball");k=i.width();g=i.height();B=G(H.gameDelay);v=H.beachDx;t=H.beachDy;h=H.maxHits;f=H.initialHits||0;u=G(H.hitInvulnerabilityDuration);y({duneSkidSpeed:H.duneSkidSpeed,maxDuneSkidSpeed:H.maxDuneSkidSpeed});q();w();a({leftRightSpeed:H.leftRightSpeed,jumpResetDelay:G(H.leftRightResetDelay),parallaxSpeed:H.parallaxSpeed});E({totalDunes:H.totalDunes});D.spawnCrab=o({minDy:H.crabMinDy,maxDy:H.crabMaxDy,scuttleSpeed:H.crabScuttleSpeed,maxCrabs:H.maxCrabs});D.events.emit("loaded.core",H)};function w(){var H=m.width(),G=m.height();return scene("#beachball",{x:(k-H)/2,y:(g-G)/2,map:n.beachballMap}).shape({type:"circle"})}function E(I){var H=I.totalDunes,K=0,L=m.width()/2,Q=L*4,N=new QuadTree({x:0,y:0,width:k,height:g},false,8);function M(T,X){var W="dune"+K,U=$("#dune").clone();U.attr("id",W);i.append(U);var V=scene("#"+W,{x:T-U.width()/2,y:X-U.height()/2,dx:v,dy:t,map:n.wrapMap}).shape({type:"rectangle"});z.push(V);N.insert(V.shape());K+=1}outer:while(K<H){var P=Math.random()*k,O=Math.random()*g;var G=N.retrieve({x:P,y:O,width:Q,height:Q});if(G.length==0){M(P,O);continue outer}for(var J=0;J<G.length;J++){var S=G[J].x-P,R=G[J].y-O;if(Math.pow(S,2)+Math.pow(R,2)<Math.pow(Q,2)){continue outer}}M(P,O)}}function q(){scene.schedule("before",function(G){s=(s+v*G)%b;r=(r+t*G)%p;i.css("background-position",s+"px "+r+"px")})}function y(J){var H=J.duneSkidSpeed,K=J.maxDuneSpeed;function G(L,R){if(R=="#beachball"){var Q=scene(R),P=scene(L),M=(P.shape().x-Q.shape().x)<0?H:-H,N=Q.vel(),O=N.x+M;O=O>K?K:O;Q.vel(O,N.y)}}function I(L,N){var M=scene(L);if(N=="#beachball"&&!l&&!M.isAttached){M.attach()}else{if(/#crab/i.test(N)){M.collideWithCrab(N)}}}scene.loadCollisions({x:0,y:0,width:k,height:g,maxDepth:8});scene.events.on("collision",function(L,M){if(d(/#dune/i,L,M)){G.apply(this,j(/#dune/i,L,M))}if(d(/#crab/i,L,M)){I.apply(this,j(/#crab/i,L,M))}})}function a(J){var K=J.leftRightResetDelay,L=Math.abs(J.leftRightSpeed)||0,H=J.parallaxSpeed,P,S,R=false,M=scene("#beachball");function Q(T){if(c){return D.invulnerable(T)}}function I(){R=true;Q(true);M.events.emit("jump-start")}function G(){R=false;Q(false);M.events.emit("jump-end")}S=C(m,{cssClass:"jump",start:I,end:G});function O(T){switch(T){case"left":M.vel(-L);e(H);break;case"right":M.vel(L);e(-H);break;case"up":if(!R){S()}break}}function N(T){switch(T){case"left":case"right":M.vel(0);e(0);break}}M.motion={enable:O,disable:N}}function o(R){var O=R.scuttleSpeed,J=R.minDy,N=R.maxDy,P=R.maxCrabs,S=R.spawnMinTime||0,W=R.spawnMaxTime||5,L=0,G=0,K=4/O,I=scene("#beachball");var M={};var X=["crab","pink-crab"];function H(){return X[Math.floor(Math.random()*X.length)]}function U(Y){}function T(aa){var Z=this;function Y(){if(Z.attached){D.events.emit("crab-detached",G-=1)}delete M[Z.name];scene.remove(Z);L-=1}if(aa){return Y()}if(this.attached){this.removeMotion("attach").addMotion("dead",function(ac,ab,ad){return{x:0,y:-20}})}C($(this.name),{cssClass:"crab-detached",end:Y})()}function Q(){var Y=I.shape().radius,Z=this,ab=$(this.name),aa;this.isCollidable=false;this.attached=true;if((I.position().x-this.position().x)>0){aa=-this.width()}else{aa=2*Y}this.style("z-index","40").removeMotion("scuttle").addMotion("attach",function(ad,ac,af){var ae=I.position();return{x:ae.x-ac+aa,y:ae.y-af+Y}});D.events.emit("crab-attached",G+=1);C(ab,{cssClass:"crab-attached",end:function(ac){A();Z.despawn()}})()}D.numAttached=function(){return G};function V(){if(L<P){L+=1;var ab=H(),ae="crab"+(new Date()).getTime(),aa=$("#"+ab).clone(),ac=J+Math.random()*(N-J),Y;function Z(ag,af,ah){return{x:0,y:ac}}function ad(af,ag){if((ac>0&&ag>=g)||(ac<0&&ag<=0)){this.despawn(true)}return{x:(af>=0)?af%k:k-(-af%k),y:ag}}aa.attr("id",ae);i.append(aa.hide());Y=M["#"+ae]=scene("#"+ae,{x:Math.random()*(k-aa.width()),y:g,map:ad}).addMotion("scuttle",Z).shape({type:"rectangle",width:aa.width()*0.9,height:aa.height()*0.9});Y.despawn=T;Y.attach=Q;Y.collideWithCrab=U;aa.show()}}D.events.on("lost restarted",function(){_.each(M,function(Y,Z){Y.despawn()})});I.events.on("jump-start",function(){_.each(M,function(Y,Z){if(Y.attached){Y.despawn()}})});return V}})(this);
